mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuYWIxMDEiLCJhIjoiY2pud3lwZGszMDZteDN4bjdtNXpyZ3EwcyJ9.dCJ_1TTKEK_OuF6S55m9qA';
var places = {
    "type": "FeatureCollection",
    "features": [{
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='https://www.geoimage.com.au/images/Galleries/Landsat8/130211_TECH_landsat_DeathValley.jpg.CROP.original-original.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",
            "sat": "LandSat8"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-79.038659, 38.931567]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='https://www.geoimage.com.au/images/Galleries/Landsat8/130211_TECH_landsat_DeathValley.jpg.CROP.original-original.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",           
            "sat": "LandSat8"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-77.003168, 38.894651]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='https://www.geoimage.com.au/images/Galleries/Landsat8/746503main_paluweh_oli_2013119_geo-crop_l8.jpg' width='350' height='300'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",           
            "sat": "LandSat8"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-72.003168, 38.894651]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",            
            "sat": "SPOT 6-7"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-78.090372, 40.881189]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",            
            "sat": "Galassia 2"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-80.052477, 42.943951]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",
            "sat": "Cartosat-2"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-78.031706, 40.914581]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='https://wp-cdn.apollomapping.com/wp-content/plugins/doptg/uploads/thumbs/jkpjwO5xwjrYksKsNXejTgrYjLaK7ANec58pBnSb2ZYX6cgGfZhLFshQBQPQAHLMs.jpg' width='350' height='300'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",
            "sat": "IKONOS"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-79.020945, 38.378241]
        }
    }, {
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='http://blogs.esa.int/eolaunches/files/2015/06/True-Colour-subset-Milano-Full-res-Final-no-layers.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div",
            "sat": "Sentinel-2"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-78.020945, 38.878241]
        }
    },{
        "type": "Feature",
        "properties": {
            "marker-color": "#06697e",
            "description": "<div class='caption-img'><img src='http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg' width='350' height='350'/></div><div class='caption-text'> <p>Download <a href=\"http://www.capitalpride.org/parade\" target=\"_blank\" title=\"Opens in a new window\">GeoTiff</a> - Show <a href=\"http://blogs.esa.int/eolaunches/files/2015/06/First-image-full-swath-RGB-cut-reduced.jpg\" target=\"_blank\" title=\"Opens in a new window\">FullScreen</a></p><p><strong>Date Taken: </strong> 2018-03-09 <strong>  Time Taken: </strong> 16:05:07 </p><p><strong>Position:  </strong> [-74.00, 40.71] </p><p><strong>Physical Size:</strong> 2000x2000km </p></div>",
            "sat": "Sentinel-2"
        },
        "geometry": {
            "type": "Point",
            "coordinates": [-76.17481, 38.876516]
        }
    }]
};

//'mapbox://styles/danab101/cjq8jefg3a1dh2smvwqb0ezei',
var filterSat = document.getElementById('filter-sat');
var filterBand = document.getElementById('filter-band');
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/bright-v9',
    center: [-77.04, 38.907],
    zoom: 5
});


map.on('load', function() {
    // Add a GeoJSON source containing place coordinates and information.
    map.addSource("places", {
        "type": "geojson",
        "data": places,
        cluster: true,
        clusterMaxZoom: 14, // Max zoom to cluster points on
        clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
    }); 

 //Cluster code, but cannot unshow unchecked    
map.addLayer({
        id: "clusters",
        type: "circle",
        source: "places",
        filter: ["has", "point_count"],
        paint: {
            // Use step expressions (https://www.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
            // with three steps to implement three types of circles:
            //   * Blue, 20px circles when point count is less than 100
            //   * Yellow, 30px circles when point count is between 100 and 750
            //   * Pink, 40px circles when point count is greater than or equal to 750
            "circle-color": [
                "step",
                ["get", "point_count"],
                "#51bbd6",
                100,
                "#f1f075",
                750,
                "#f28cb1"
            ],
            "circle-radius": [
                "step",
                ["get", "point_count"],
                20,
                100,
                30,
                750,
                40
            ]
        }
    });

    map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "places",
        filter: ["has", "point_count"],
        layout: {
            "text-field": "{point_count_abbreviated}",
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 12
        }
    });

    map.addLayer({
        id: "unclustered-point",
        type: "circle",
        source: "places",
        filter: ["!", ["has", "point_count"]],
        paint: {
            "circle-color": "#11b4da",
            "circle-radius": 4,
            "circle-stroke-width": 1,
            "circle-stroke-color": "#fff"
        }
    });

    // inspect a cluster on click
    map.on('click', 'clusters', function (e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        var clusterId = features[0].properties.cluster_id;
        map.getSource('places').getClusterExpansionZoom(clusterId, function (err, zoom) {
            if (err)
                return;

            map.easeTo({
                center: features[0].geometry.coordinates,
                zoom: zoom
            });
        });
    });

    map.on('mouseenter', 'clusters', function () {
        map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'clusters', function () {
        map.getCanvas().style.cursor = '';
    });
//End of cluster 
    places.features.forEach(function(feature) {
        var symbol = feature.properties['sat'];
        var layerID = 'poi-' + symbol;

        // Add a layer for this symbol type if it hasn't been added already.
        if (!map.getLayer(layerID)) {
            map.addLayer({
                "id": layerID,
                "type": "symbol",
                "source": "places",
                "layout": {
                    "icon-image": "marker-15",
                    "icon-allow-overlap": true
                },
                "filter": ["==", "sat", symbol]
            });


            // Add checkbox and label elements for the layer.
            var input = document.createElement('input');
            input.type = 'checkbox';
            input.id = layerID;
            input.checked = true;
            filterSat.appendChild(input);

            var label = document.createElement('label');
            label.setAttribute('for', layerID);
            label.textContent = symbol;
            filterSat.appendChild(label);

            // When the checkbox changes, update the visibility of the layer.
            input.addEventListener('change', function(e) {
                map.setLayoutProperty(layerID, 'visibility',
                    e.target.checked ? 'visible' : 'none');
            });
        }

            // When a click event occurs on a feature in the places layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', layerID, function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.description;

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
    });

    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', layerID, function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', layerID, function () {
        map.getCanvas().style.cursor = '';
    });

    });

});

//search engin
var geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken
});

document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

//Draw Polygon
var draw = new MapboxDraw({
    displayControlsDefault: false,
    controls: {
        polygon: true,
        trash: true,
        line_string: true,
    }
});
map.addControl(draw);

map.on('draw.create', updateArea);
map.on('draw.delete', updateArea);
map.on('draw.update', updateArea);

function updateArea(e) {
    var data = draw.getAll();
    var answer = document.getElementById('calculated-area');
    if (data.features.length > 0) {
        var area = turf.area(data);
        var distance = turf.lineDistance(data).toLocaleString();
        // restrict to area to 2 decimal points
        var rounded_area = Math.round(area*100)/100;
        rounded_area = rounded_area/1000000
        //answer.innerHTML = rounded_area + ' square kilometers'; ??
        answer.innerHTML = '<strong>Distance = ' + distance + '</strong> km ' + '<strong>Area = ' + rounded_area.toFixed(4) + '</strong> km^2';
        //answer.innerHTML = '<strong>Distance = ' + distance + '</strong> km';
    } else {
        answer.innerHTML = '';
        if (e.type !== 'draw.delete') alert("Use the draw tools to draw a polygon!");
    }
}

//Show Lat and Long
map.on('mousemove', function (e) {

    document.getElementById('info').innerHTML =
        // e.lngLat is the longitude, latitude geographical position of the event
       "Longitude = " + e.lngLat.lng.toFixed(4) + " Latitude = " + e.lngLat.lat.toFixed(4);
});
